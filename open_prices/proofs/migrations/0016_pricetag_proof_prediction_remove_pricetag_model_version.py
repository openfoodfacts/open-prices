# Generated by Django 5.1.4 on 2025-03-18 11:47

import django.db.models.deletion
from django.db import migrations, models


def init_proof_prediction(apps, schema_editor):
    Proof = apps.get_model("proofs", "Proof")
    for proof in Proof.objects.filter(type="PRICE_TAG"):
        proof_prediction_price_tag_qs = proof.predictions.filter(
            type="OBJECT_DETECTION", model_name="price_tag_detection"
        )
        if proof_prediction_price_tag_qs.count() == 1:
            proof.price_tags.update(
                proof_prediction=proof_prediction_price_tag_qs.first()
            )


class Migration(migrations.Migration):
    dependencies = [
        ("proofs", "0015_proof_owner_consumption"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="pricetag",
            name="model_version",
        ),
        migrations.AddField(
            model_name="pricetag",
            name="proof_prediction",
            field=models.ForeignKey(
                blank=True,
                help_text="The proof prediction used to create this price tag. Null if created by a user.",
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="price_tags",
                to="proofs.proofprediction",
            ),
        ),
        migrations.RunPython(init_proof_prediction),
    ]
