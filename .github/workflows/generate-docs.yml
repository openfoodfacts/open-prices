#----------------------------------------------
# Generate and upload documentation (only on push to main)
#----------------------------------------------

    name: Generate documentation
    on:
      pull_request:
        # on pull request we just want to build to see nothing is broken
        paths:
        - "docs/**"
        - ".github/workflows/generate-docs.yml"
        - "mkdocs.yml"
      push:
        branches:
          - main

    jobs:
      publish-docs:
        runs-on: ubuntu-slim
        strategy:
          matrix:
            python-version: [3.11]
        steps:
          - name: Check out the repo
            uses: actions/checkout@v6

          - name: Setup Python version
            uses: actions/setup-python@v6
            with:
              python-version: ${{ matrix.python-version }}

          - name: Install uv
            uses: astral-sh/setup-uv@v5

          - name: Load cached uv
            uses: actions/cache@v5
            with:
              path: ~/.cache/uv
              key: uv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/uv.lock') }}

          - name: Install dependencies
            run: uv sync --group dev --frozen

          - name: Generate documentation
            run: bash ./build_mkdocs.sh

          # Deploy docs to gh_pages if we are pushing to main
          # Example from https://github.com/marketplace/actions/deploy-to-github-pages
          - name: Deploy ðŸš€
            # we only deploy on push to main from the main repository
            if: |
              github.repository_owner == 'openfoodfacts' && github.event_name == 'push' && github.event.ref == 'refs/heads/main'
            uses: JamesIves/github-pages-deploy-action@v4.8.0
            with:
              token: ${{ secrets.GITHUB_TOKEN }}
              branch: gh-pages # The branch the action should deploy to.
              folder: gh_pages # The folder the action should deploy.
              clean: true # Automatically remove deleted files from the deploy branch
